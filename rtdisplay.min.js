var rendererOptions={draggable:!0},map,mbtaRTLayer,mbtaKeyBusLayer,boston=new google.maps.LatLng(42.37,-71.1),markers={},savedWPs=[],numPoints=2,points=new Points(numPoints),usedPoints=0,numMarkers=0,lastIndex={},freeColors=[],animInterval=10,mostRecentUpdate={},routeNames={701:"CT1",747:"CT2",708:"CT3",741:"SL1",742:"SL2",751:"SL4",749:"SL5"};function getRouteName(a){return a in routeNames?routeNames[a]:a}
function newISO8601Date(a){year=a.substr(0,4);mon=a.substr(5,2);day=a.substr(8,2);rest=a.substr(10);newD=day+" "+"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")[parseInt(mon)-1]+" "+year+rest+" EDT";return new Date(newD)}function findLastIndices(a){for(i in a)lastIndex[a[i].vehicle]=i}
function pickColor(){var a;if(a=freeColors.pop())return a;if(usedPoints>=numPoints){points=new Points(2*numPoints);for(i=0;i<numPoints;i++)points.pick();numPoints*=2}a=points.pick();usedPoints++;a=RYB.rgb.apply(RYB,a).map(function(a){return Math.floor(255*a)});return a="rgb("+a[0]+", "+a[1]+", "+a[2]+")"}google.maps.LatLng.prototype.latRadians=function(){return Math.PI*this.lat()/180};google.maps.LatLng.prototype.lngRadians=function(){return Math.PI*this.lng()/180};
function bearing(a,c){var d=a.latRadians(),b=a.lngRadians(),e=c.latRadians(),f=c.lngRadians(),d=-Math.atan2(Math.sin(b-f)*Math.cos(e),Math.cos(d)*Math.sin(e)-Math.sin(d)*Math.cos(e)*Math.cos(b-f));0>d&&(d+=2*Math.PI);d=180*d/Math.PI;return parseFloat(d.toFixed(1))}function reapDeadVehicles(a){for(id in animInfo)lastIndex[id]<a&&(freeColors.push(animInfo[id].color),animInfo[id].line&&animInfo[id].line.setMap(null),markers[id]&&markers[id].setMap(null),delete animInfo[id])}var inactivityInterval=6E5;
function hideInactive(a){for(id in animInfo)animInfo[id].line&&animInfo[id].line.getVisible()&&a-new Date(animInfo[id].lastUpdate)>inactivityInterval&&(animInfo[id].line&&animInfo[id].line.setVisible(!1),markers[id]&&markers[id].setMap(null))}function rewind(a){for(curTime=new Date(curTime.getTime()-a);newISO8601Date(rt[curI].l1ts)>curTime&&0<curI;)curI--;clearAll()}function fastForward(a){curTime=new Date(curTime.getTime()+a);clearAll()}
function clearAll(){for(id in animInfo)animInfo[id].line&&animInfo[id].line.setMap(null);for(id in markers)markers[id].setMap(null)}function flashControl(a){a.css("background-color","black");a.animate({"background-color":"white"},"fast")}
function createLegend(){var a=document.createElement("div");a.id="legend";a.style.padding="5px";a.style.backgroundColor="white";a.style.borderStyle="solid";a.style.borderWidth="1px";var c=document.createElement("div");c.id="currentTime";a.appendChild(c);descDiv=document.createElement("div");descDiv.id="desc";descDiv.innerHTML='<table><tr><td><input type="checkbox" id="showStopRequest" checked/></td><td><div class="circle" style="background-color:red"></div></td><td>Stop Request</td></tr><tr><td><input type="checkbox" id="showDoorOpen" checked/></td><td><div class="circle" style="background-color:blue"></div></td><td>Door Open</td></tr></table>';
a.appendChild(descDiv);controlsDiv=document.createElement("div");controlsDiv.id="controls";controlsDiv.innerHTML='<div id="rw"><div class="arrow-left"></div><div class="arrow-left"></div></div> <div id="p"><div class="pauserect"></div><div class="pauserect"></div></div> <div id="ff"><div class="arrow-right"></div><div class="arrow-right"></div></div>';a.appendChild(controlsDiv);map.controls[google.maps.ControlPosition.TOP].push(a);$(document).on("click","#controls #rw",function(){rewind(1E6);runForOne=
!0;flashControl($("#controls #rw"))});$(document).on("click","#controls #ff",function(){fastForward(1E6);runForOne=!0;flashControl($("#controls #ff"))});$(document).on("click","#controls #p",function(){(pausing=!pausing)?$("#controls #p").html('<div class="arrow-right"></div>'):$("#controls #p").html('<div class="pauserect"></div><div class="pauserect"></div>');flashControl($("#controls #p"))});$(document).on("change","#showStopRequest",function(){showStopRequest=$("#showStopRequest").prop("checked")});
$(document).on("change","#showDoorOpen",function(){showDoorOpen=$("#showDoorOpen").prop("checked")});setTimeout(function(){$("#legend").live("selectstart dragstart",function(a){a.preventDefault();return!1})},1E3)}function pad2(a){return(10>a?"0":"")+a.toString()}var pausing=!1,runForOne=!1,showDoorOpen=!0,showStopRequest=!0,lines={},animInfo={},curTime,curI,rt,progresslen,curprogress,allRoutes={};
function getScript(a,c){var d=document.createElement("script");d.setAttribute("type","text/javascript");d.setAttribute("src",a);d.onerror=c;var b=document.getElementsByTagName("head")[0];b.appendChild(d);d.onload=d.onreadystatechange=function(){if(!this.readyState||"loaded"==this.readyState||"complete"==this.readyState)c(),d.onload=d.onreadystatechange=null,b.removeChild(d)}}
function loadScripts(a,c){if(0<a.length){console.log("loading "+a[0]);var d=rtdata.length;getScript(a[0],function(){d<rtdata.length?(rt=rtdata,a.shift(),curprogress++,$("#progressbar").progressbar("value",curprogress),loadScripts(a,c)):(console.log("retrying "+a[0]),setTimeout(function(){loadScripts(a,c)},1E3))})}else $("#progressbar").fadeOut("slow"),c()}function getRouteList(){var a,c={};for(a in rt)c[rt[a].route]=!0;return c}
function routeOrder(a,c){var d=parseInt(getRouteName(a)),b=parseInt(getRouteName(c));return isNaN(d)&&isNaN(b)?getRouteName(a)<=getRouteName(c)?-1:1:isNaN(d)&&!isNaN(b)?1:!isNaN(d)&&isNaN(b)?-1:d==b?a<c?-1:1:d-b}
function createRouteDiv(){allRoutes=getRouteList();var a=document.createElement("div");a.id="routes";a.style.padding="5px";a.style.backgroundColor="white";a.style.borderStyle="solid";a.style.borderWidth="1px";var c=document.createElement("div");c.innerHTML='<input type="checkbox" id="checkall" checked/> <b>All</b>';a.appendChild(c);$(document).on("change","#routes #checkall",function(){$("#routes input.route").prop("checked",$("#routes #checkall").prop("checked"));$("#routes input.route").change()});
c=[];for(d in allRoutes)c.push(d);c.sort(routeOrder);for(r in c){var d=c[r],b=document.createElement("div");b.innerHTML='<input type="checkbox" class="route" id="'+d+'" checked/> '+getRouteName(d);a.appendChild(b);(function(a){$(document).on("change","#routes #"+a,function(){allRoutes[a]=$("#routes #"+a).prop("checked")})})(d)}map.controls[google.maps.ControlPosition.RIGHT].push(a)}
function createMapOptionsDiv(){var a=document.createElement("div");a.id="mapOpts";a.style.padding="5px";a.style.backgroundColor="white";a.style.borderStyle="solid";a.style.borderWidth="1px";var c=document.createElement("div");c.id="showRoutes";c.innerHTML='<input type="checkbox" id="showRoutes" checked/> Show Routes?';a.appendChild(c);$(document).on("change","#mapOpts input#showRoutes",function(){$("#mapOpts input#showRoutes").prop("checked")?mbtaKeyBusLayer.setMap(map):mbtaKeyBusLayer.setMap(null)});
map.controls[google.maps.ControlPosition.RIGHT].push(a)}
$(document).ready(function(){rt=rtdata;progresslen=rtscripts.length;curprogress=0;$("#progressbar").progressbar({value:0,max:progresslen});loadScripts(rtscripts,function(){createRouteDiv()});var a={center:boston,zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("map_canvas"),a);mbtaRTLayer=new google.maps.TransitLayer;mbtaRTLayer.setMap(map);mbtaKeyBusLayer=new google.maps.KmlLayer("http://walkingbostonian.heliohost.org/MBTA_KeyBusSL_a25.kml");mbtaKeyBusLayer.setMap(map);
createLegend();createMapOptionsDiv();0<rt.length?(curI=0,curTime=newISO8601Date(rt[0].l1ts)):curI=-1;var c=setInterval(function(){if(!(0==rt.length||pausing&&!runForOne)){-1==curI&&(curI=0,curTime=newISO8601Date(rt[0].l1ts));$("#currentTime").text(curTime.toDateString()+" "+pad2(curTime.getHours())+":"+pad2(curTime.getMinutes()));for(b in animInfo)if(0<animInfo[b].secsRem){animInfo[b].secsRem--;var a=animInfo[b].line.get("icons");a[0].offset=Math.min(100,parseFloat(a[0].offset.slice(0,-1))+animInfo[b].deltaPercent)+
"%";animInfo[b].line.set("icons",a)}for(;newISO8601Date(rt[curI].l1ts)<=curTime;){var b=rt[curI].vehicle,e=rt[curI].route;animInfo[b]?animInfo[b].line&&animInfo[b].line.setVisible(!1):animInfo[b]={secsRem:0,deltaPercent:0,line:null,color:null,lastUpdate:null};!(e in allRoutes)||!0==allRoutes[e]?(e=[new google.maps.LatLng(rt[curI].l1location[0],rt[curI].l1location[1]),new google.maps.LatLng(rt[curI].l2location[0],rt[curI].l2location[1])],a=Math.floor((newISO8601Date(rt[curI].l2ts)-newISO8601Date(rt[curI].l1ts))/
1E3),animInfo[b].secsRem=a,animInfo[b].deltaPercent=100/a,animInfo[b].lastUpdate=newISO8601Date(rt[curI].l1ts),animInfo[b].line?(animInfo[b].line.setPath(e),a=animInfo[b].line.get("icons"),a[0].offset="0%",animInfo[b].line.set("icons",a),animInfo[b].line.setVisible(!0),animInfo[b].line.setMap(map)):(a=pickColor(),animInfo[b].line=new google.maps.Polyline({path:e,scale:0,strokeColor:"rgba(0,0,0,0)",icons:[{icon:{path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW,scale:3,fillColor:a,fillOpacity:0.75,
strokeColor:"black",strokeWeight:1},offset:"0%"}],map:map}),animInfo[b].color=a),"Stop request"==rt[curI].l1mtype&&showStopRequest||"Door open"==rt[curI].l1mtype&&showDoorOpen?(e={position:e[0],map:map,flat:!0,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:"Stop request"==rt[curI].l1mtype?"red":"blue",fillOpacity:1,scale:5,strokeWeight:1}},markers[b]?markers[b].setOptions(e):markers[b]=new google.maps.Marker(e)):markers[b]&&markers[b].setMap(null)):markers[b]&&markers[b].setMap(null);curI++;if(curI>=
rt.length){clearInterval(c);return}}curTime=new Date(curTime.getTime()+1E3);hideInactive(curTime);runForOne=!1}},animInterval)});
